name: build-on-linux-riscv64

on:
  workflow_dispatch:
  workflow_call:
  push:
    tags:
      - "v*"

jobs:
  init:
    uses: ./.github/workflows/get-targets.yml

  build_targets_on_linux_riscv64_cross:
    name: Build cross
    runs-on: ubuntu-latest
    needs:
      - init
    strategy:
      fail-fast: false
      matrix:
        targets: ${{ fromJSON(needs.init.outputs.TARGETS) }}
    steps:
      - uses: actions/checkout@v4

      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: ${{ github.workspace }}/.ccache
          key: ccache-linux-riscv64-${{ matrix.targets }}-${{ github.sha }}
          restore-keys: |
            ccache-linux-riscv64-${{ matrix.targets }}-

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Build
        id: build
        run: |
          docker run --rm \
            --platform linux/riscv64 \
            --volume "${PWD}:/build" \
            --volume "${{ github.workspace }}/.ccache:/root/.ccache" \
            riscv64/alpine:edge \
            /bin/sh -c '
              apk add --no-cache \
                coreutils \
                curl \
                bzip2 \
                xz \
                make \
                bison \
                rsync \
                patch \
                perl \
                flex \
                g++ \
                texinfo \
                python3 \
                gawk \
                grep \
                bash \
                tar \
                file \
                ccache \
                yq && \
              cd /build && \
              export CROSS_DIST_NAME_SUFFIX="-linux-riscv64" && \
              export CCACHE_DIR=/root/.ccache && \
              export CCACHE_TEMPDIR=/tmp && \
              export CCACHE_MAXSIZE=20M && \
              export CCACHE_COMPRESS=true && \
              export CCACHE_COMPRESSLEVEL=5 && \
              bash scripts/build.sh \
                -LDP \
                -a \
                -b \
                -T "${{ matrix.targets }}"'

      - name: Upload dist
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.targets }}-linux-riscv64
          path: |
            dist
            !dist/*.log

  release:
    name: Release
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    needs:
      - init
      - build_targets_on_linux_riscv64_cross
    strategy:
      fail-fast: false
      matrix:
        targets: ${{ fromJSON(needs.init.outputs.TARGETS) }}
    steps:
      - uses: actions/checkout@v4

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.targets }}-linux-riscv64
          path: dist

      - name: Generate release notes
        id: release_notes
        run: |
          NOTES=$(bash scripts/generate-release-notes.sh "${{ github.ref_name }}")
          echo "NOTES<<EOF" >> $GITHUB_OUTPUT
          echo "$NOTES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RELEASE_NOTES: ${{ steps.release_notes.outputs.NOTES }}
        run: |
          gh release view "${{ github.ref_name }}" --repo ${{ github.repository }} || \
            gh release create "${{ github.ref_name }}" --repo ${{ github.repository }} --title "${{ github.ref_name }}" --notes "$RELEASE_NOTES" || true
          gh release upload "${{ github.ref_name }}" dist/*.* --clobber --repo ${{ github.repository }}
