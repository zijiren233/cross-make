name: Native Build

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag to download cross compilers from (optional for branch trigger)"
        required: false
        type: string
      platform:
        description: "Build platform (must match the release tag platform)"
        required: true
        type: choice
        options:
          - linux-aarch64
          - linux-x86_64
        default: linux-aarch64

jobs:
  # Get all targets using shared workflow
  get-targets:
    uses: ./.github/workflows/get-targets.yml

  # Build jobs - split into 8 chunks to avoid GitHub's 256 job limit
  build_1:
    needs: get-targets
    if: needs.get-targets.outputs.TARGETS_1 != '[]'
    uses: ./.github/workflows/native-multi.yml
    with:
      tag: ${{ inputs.tag }}
      targets: ${{ needs.get-targets.outputs.TARGETS_1 }}
      build-platform: ${{ inputs.platform }}
    secrets: inherit

  build_2:
    needs: get-targets
    if: needs.get-targets.outputs.TARGETS_2 != '[]'
    uses: ./.github/workflows/native-multi.yml
    with:
      tag: ${{ inputs.tag }}
      targets: ${{ needs.get-targets.outputs.TARGETS_2 }}
      build-platform: ${{ inputs.platform }}
    secrets: inherit

  build_3:
    needs: get-targets
    if: needs.get-targets.outputs.TARGETS_3 != '[]'
    uses: ./.github/workflows/native-multi.yml
    with:
      tag: ${{ inputs.tag }}
      targets: ${{ needs.get-targets.outputs.TARGETS_3 }}
      build-platform: ${{ inputs.platform }}
    secrets: inherit

  build_4:
    needs: get-targets
    if: needs.get-targets.outputs.TARGETS_4 != '[]'
    uses: ./.github/workflows/native-multi.yml
    with:
      tag: ${{ inputs.tag }}
      targets: ${{ needs.get-targets.outputs.TARGETS_4 }}
      build-platform: ${{ inputs.platform }}
    secrets: inherit

  build_5:
    needs: get-targets
    if: needs.get-targets.outputs.TARGETS_5 != '[]'
    uses: ./.github/workflows/native-multi.yml
    with:
      tag: ${{ inputs.tag }}
      targets: ${{ needs.get-targets.outputs.TARGETS_5 }}
      build-platform: ${{ inputs.platform }}
    secrets: inherit

  build_6:
    needs: get-targets
    if: needs.get-targets.outputs.TARGETS_6 != '[]'
    uses: ./.github/workflows/native-multi.yml
    with:
      tag: ${{ inputs.tag }}
      targets: ${{ needs.get-targets.outputs.TARGETS_6 }}
      build-platform: ${{ inputs.platform }}
    secrets: inherit

  build_7:
    needs: get-targets
    if: needs.get-targets.outputs.TARGETS_7 != '[]'
    uses: ./.github/workflows/native-multi.yml
    with:
      tag: ${{ inputs.tag }}
      targets: ${{ needs.get-targets.outputs.TARGETS_7 }}
      build-platform: ${{ inputs.platform }}
    secrets: inherit

  build_8:
    needs: get-targets
    if: needs.get-targets.outputs.TARGETS_8 != '[]'
    uses: ./.github/workflows/native-multi.yml
    with:
      tag: ${{ inputs.tag }}
      targets: ${{ needs.get-targets.outputs.TARGETS_8 }}
      build-platform: ${{ inputs.platform }}
    secrets: inherit
