name: build-on-linux-riscv64

on:
  workflow_dispatch:
  workflow_call:
  push:
    tags:
      - "v*"

jobs:
  init:
    uses: ./.github/workflows/get-targets.yml

  # Build jobs - split into 4 chunks to avoid GitHub's 256 job limit
  build_1:
    needs: init
    uses: ./.github/workflows/reusable-build.yml
    with:
      targets: ${{ needs.init.outputs.TARGETS_1 }}
      platform: linux-riscv64
      runs-on: ubuntu-latest
      docker-platform: linux/riscv64
      docker-image: riscv64/alpine:edge
      use-qemu: true
      use-docker: true

  build_2:
    needs: init
    uses: ./.github/workflows/reusable-build.yml
    with:
      targets: ${{ needs.init.outputs.TARGETS_2 }}
      platform: linux-riscv64
      runs-on: ubuntu-latest
      docker-platform: linux/riscv64
      docker-image: riscv64/alpine:edge
      use-qemu: true
      use-docker: true

  build_3:
    needs: init
    uses: ./.github/workflows/reusable-build.yml
    with:
      targets: ${{ needs.init.outputs.TARGETS_3 }}
      platform: linux-riscv64
      runs-on: ubuntu-latest
      docker-platform: linux/riscv64
      docker-image: riscv64/alpine:edge
      use-qemu: true
      use-docker: true

  build_4:
    needs: init
    uses: ./.github/workflows/reusable-build.yml
    with:
      targets: ${{ needs.init.outputs.TARGETS_4 }}
      platform: linux-riscv64
      runs-on: ubuntu-latest
      docker-platform: linux/riscv64
      docker-image: riscv64/alpine:edge
      use-qemu: true
      use-docker: true

  # Release jobs - split into 4 chunks to match build jobs
  release_1:
    needs: [init, build_1]
    uses: ./.github/workflows/reusable-release.yml
    with:
      targets: ${{ needs.init.outputs.TARGETS_1 }}
      platform: linux-riscv64

  release_2:
    needs: [init, build_2]
    uses: ./.github/workflows/reusable-release.yml
    with:
      targets: ${{ needs.init.outputs.TARGETS_2 }}
      platform: linux-riscv64

  release_3:
    needs: [init, build_3]
    uses: ./.github/workflows/reusable-release.yml
    with:
      targets: ${{ needs.init.outputs.TARGETS_3 }}
      platform: linux-riscv64

  release_4:
    needs: [init, build_4]
    uses: ./.github/workflows/reusable-release.yml
    with:
      targets: ${{ needs.init.outputs.TARGETS_4 }}
      platform: linux-riscv64
