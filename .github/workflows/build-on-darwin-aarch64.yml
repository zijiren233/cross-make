name: build-on-darwin-aarch64

on:
  workflow_dispatch:
  workflow_call:
  push:
    tags:
      - "v*"

jobs:
  init:
    uses: ./.github/workflows/get-targets.yml

  build_targets_on_macos_aarch64:
    name: Build
    runs-on: macos-15
    needs:
      - init
    strategy:
      fail-fast: false
      matrix:
        targets: ${{ fromJSON(needs.init.outputs.TARGETS) }}
    steps:
      - uses: actions/checkout@v4

      - name: Create Case-sensitive volume
        run: |
          diskutil list
          diskutil apfs addVolume disk3 "Case-sensitive APFS" cross
          cp -r ./* /Volumes/cross

      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: /Volumes/cross/.ccache
          key: ccache-darwin-aarch64-${{ matrix.targets }}-${{ github.sha }}
          restore-keys: |
            ccache-darwin-aarch64-${{ matrix.targets }}-

      - name: Init Dependencies
        run: |
          brew install \
            make \
            gnu-sed \
            gawk \
            gpatch \
            coreutils \
            findutils \
            gcc@14 \
            perl \
            libtool \
            bison \
            texinfo \
            ccache \
            yq

      - name: Build
        working-directory: /Volumes/cross
        run: |
          export CROSS_DIST_NAME_SUFFIX="-darwin-aarch64"
          export CCACHE_DIR=/Volumes/cross/.ccache
          export CCACHE_TEMPDIR=/tmp
          export CCACHE_MAXSIZE=20M
          export CCACHE_COMPRESS=true
          export CCACHE_COMPRESSLEVEL=5
          bash scripts/build.sh \
            -LDP \
            -c "gcc-14" -x "g++-14" \
            -a \
            -b \
            -T "${{ matrix.targets }}"

      - name: Upload dist
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.targets }}-darwin-aarch64
          path: |
            /Volumes/cross/dist
            !/Volumes/cross/dist/*.log

  release:
    name: Release
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    needs:
      - init
      - build_targets_on_macos_aarch64
    strategy:
      fail-fast: false
      matrix:
        targets: ${{ fromJSON(needs.init.outputs.TARGETS) }}
    steps:
      - uses: actions/checkout@v4

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.targets }}-darwin-aarch64
          path: dist

      - name: Generate release notes
        id: release_notes
        run: |
          NOTES=$(bash scripts/generate-release-notes.sh "${{ github.ref_name }}")
          echo "NOTES<<EOF" >> $GITHUB_OUTPUT
          echo "$NOTES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RELEASE_NOTES: ${{ steps.release_notes.outputs.NOTES }}
        run: |
          gh release view "${{ github.ref_name }}" --repo ${{ github.repository }} || \
            gh release create "${{ github.ref_name }}" --repo ${{ github.repository }} --title "${{ github.ref_name }}" --notes "$RELEASE_NOTES" || true
          gh release upload "${{ github.ref_name }}" dist/*.* --clobber --repo ${{ github.repository }}
