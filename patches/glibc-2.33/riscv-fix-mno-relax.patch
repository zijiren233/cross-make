From 09f214528c21f2825790d11ed9d1ac18d0657d48 Mon Sep 17 00:00:00 2001
From: Adhemerval Zanella <adhemerval.zanella@linaro.org>
Date: Tue, 2 Nov 2021 16:51:39 -0300
Subject: [PATCH] riscv: Build with -mno-relax if linker does not support
 R_RISCV_ALIGN

It allows build both glibc and tests with lld (Since lld does not
support R_RISCV_ALIGN linker relaxation).

Checked with a build for riscv32-linux-gnu-rv32imafdc-ilp32d and
riscv64-linux-gnu-rv64imafdc-lp64d.

Reviewed-by: H.J. Lu <hjl.tools@gmail.com>
Reviewed-by: Fangrui Song <maskray@google.com>
---
 sysdeps/riscv/Makefile     |  6 ++++++
 sysdeps/riscv/configure    | 30 ++++++++++++++++++++++++++++++
 sysdeps/riscv/configure.ac | 16 ++++++++++++++++
 3 files changed, 52 insertions(+)

diff --git a/sysdeps/riscv/Makefile b/sysdeps/riscv/Makefile
index 20a9968106..8fb10b164f 100644
--- a/sysdeps/riscv/Makefile
+++ b/sysdeps/riscv/Makefile
@@ -5,3 +5,9 @@ endif
 # RISC-V's assembler also needs to know about PIC as it changes the definition
 # of some assembler macros.
 ASFLAGS-.os += $(pic-ccflag)
+
+ifeq (no,$(riscv-r-align))
+ASFLAGS-.os += -Wa,-mno-relax
+ASFLAGS-.o += -Wa,-mno-relax
+sysdep-CFLAGS += -mno-relax
+endif
diff --git a/sysdeps/riscv/configure b/sysdeps/riscv/configure
index 53f5f1b5f1..4a56fca94b 100644
--- a/sysdeps/riscv/configure
+++ b/sysdeps/riscv/configure
@@ -2,3 +2,33 @@
  # Local configure fragment for sysdeps/riscv/elf.
 
 $as_echo "#define PI_STATIC_AND_HIDDEN 1" >>confdefs.h
+
+
+# Check if static linker supports R_RISCV_ALIGN
+{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for R_RISCV_ALIGN linker relaxation support" >&5
+$as_echo_n "checking for R_RISCV_ALIGN linker relaxation support... " >&6; }
+if ${libc_cv_riscv_r_align+:} false; then :
+  $as_echo_n "(cached) " >&6
+else
+    cat > conftest.S <<EOF
+.align 3
+foo:
+  li a0,42
+  ret
+EOF
+  libc_cv_riscv_r_align=no
+  if { ac_try='${CC-cc} $CFLAGS $CPPFLAGS $LDFLAGS -nostdlib -nostartfiles $no_ssp -shared -fPIC -o contests.o conftest.S'
+  { { eval echo "\"\$as_me\":${as_lineno-$LINENO}: \"$ac_try\""; } >&5
+  (eval $ac_try) 2>&5
+  ac_status=$?
+  $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
+  test $ac_status = 0; }; }
+  then
+    libc_cv_riscv_r_align=yes
+  fi
+  rm -rf conftest.*
+fi
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $libc_cv_riscv_r_align" >&5
+$as_echo "$libc_cv_riscv_r_align" >&6; }
+config_vars="$config_vars
+riscv-r-align = $libc_cv_riscv_r_align"
diff --git a/sysdeps/riscv/configure.ac b/sysdeps/riscv/configure.ac
index 34f62d4b4b..44a5279903 100644
--- a/sysdeps/riscv/configure.ac
+++ b/sysdeps/riscv/configure.ac
@@ -2,3 +2,19 @@ GLIBC_PROVIDES dnl See aclocal.m4 in the top level source directory.
 # Local configure fragment for sysdeps/riscv/elf.
 
 AC_DEFINE(PI_STATIC_AND_HIDDEN)
+
+# Check if static linker supports R_RISCV_ALIGN
+AC_CACHE_CHECK([for R_RISCV_ALIGN linker relaxation support], [libc_cv_riscv_r_align],[dnl
+  cat > conftest.S <<EOF
+.align 3
+foo:
+  li a0,42
+  ret
+EOF
+  libc_cv_riscv_r_align=no
+  if AC_TRY_COMMAND([${CC-cc} $CFLAGS $CPPFLAGS $LDFLAGS -nostdlib -nostartfiles $no_ssp -shared -fPIC -o contests.o conftest.S])
+  then
+    libc_cv_riscv_r_align=yes
+  fi
+  rm -rf conftest.*])
+LIBC_CONFIG_VAR([riscv-r-align], [$libc_cv_riscv_r_align])
-- 
2.52.0

