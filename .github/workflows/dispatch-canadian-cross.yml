name: Dispatch Canadian Cross Builds

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag (e.g., v1.0.0). Required for tag trigger, optional for branch trigger (used to download dependencies)"
        required: false
        type: string
      platform:
        description: "Build platform"
        required: true
        type: choice
        options:
          - linux-aarch64
          - linux-x86_64
        default: linux-aarch64
      hosts:
        description: 'Canadian Cross hosts (space-separated, or "all" for default list)'
        required: false
        type: string
        default: "all"
  workflow_call:
    inputs:
      tag:
        description: "Release tag (optional for branch trigger)"
        required: false
        type: string
      platform:
        description: "Build platform"
        required: true
        type: string
      hosts:
        description: 'Canadian Cross hosts (space-separated, or "all" for default list)'
        required: false
        type: string
        default: "all"

env:
  DEFAULT_HOSTS: "x86_64-w64-mingw32 x86_64-linux-musl loongarch64-linux-musl s390x-linux-musl powerpc64-linux-musl powerpc64le-linux-musl mips64-linux-musl mips64el-linux-musl riscv64-linux-musl"

jobs:
  dispatch:
    name: Dispatch Canadian Cross
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4

      - name: Resolve tag
        id: tag
        uses: ./.github/actions/resolve-tag
        with:
          tag: ${{ inputs.tag }}

      - name: Dispatch Canadian Cross builds
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TAG="${{ steps.tag.outputs.tag }}"
          PLATFORM="${{ inputs.platform }}"
          HOSTS_INPUT="${{ inputs.hosts }}"
          CURRENT_REF="${{ github.ref }}"

          # Use default hosts if "all" or empty
          if [ "$HOSTS_INPUT" = "all" ] || [ -z "$HOSTS_INPUT" ]; then
            HOSTS="$DEFAULT_HOSTS"
          else
            HOSTS="$HOSTS_INPUT"
          fi

          for HOST in $HOSTS; do
            echo "Dispatching build for host: $HOST"
            gh workflow run canadian-cross.yml \
              --repo "${{ github.repository }}" \
              --ref "$CURRENT_REF" \
              -f tag="$TAG" \
              -f host="$HOST" \
              -f platform="$PLATFORM"

            # Small delay to avoid rate limiting
            sleep 2
          done

          echo ""
          echo "All Canadian Cross builds dispatched"
