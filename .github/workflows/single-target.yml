name: Single Target Build

on:
  workflow_dispatch:
    inputs:
      target:
        description: "Target to build"
        required: true
        type: string
      platform:
        description: "Platform"
        required: true
        type: choice
        options:
          - linux-x86_64
          - linux-aarch64
          - linux-armv7
          - linux-riscv64
          - linux-powerpc64le
          - linux-s390x
          - darwin-aarch64
          - darwin-x86_64
      tag:
        description: "Release tag (optional, defaults to current ref)"
        required: false
        type: string
        default: ""
      extra-build-flags:
        description: "Extra flags for build.sh"
        required: false
        type: string
        default: ""
  workflow_call:
    inputs:
      target:
        description: "Single target to build"
        required: true
        type: string
      platform:
        description: "Platform identifier (e.g., linux-aarch64, darwin-x86_64)"
        required: true
        type: string
      extra-build-flags:
        description: "Extra flags for build.sh"
        required: false
        type: string
        default: ""
      sources-cache-key:
        description: "Pre-computed sources cache key (skip calculation if provided)"
        required: false
        type: string
        default: ""
      sources-artifact:
        description: "Artifact name to download sources from (if provided, skip cache and download from artifact)"
        required: false
        type: string
        default: ""

jobs:
  setup:
    name: Setup ${{ inputs.target }}
    runs-on: ubuntu-24.04
    outputs:
      runs-on: ${{ steps.config.outputs.runs-on }}
      docker-platform: ${{ steps.config.outputs.docker-platform }}
      docker-image: ${{ steps.config.outputs.docker-image }}
      use-qemu: ${{ steps.config.outputs.use-qemu }}
      sources-cache-key: ${{ inputs.sources-cache-key || steps.cache-key.outputs.key }}
    steps:
      - uses: actions/checkout@v4
        if: inputs.sources-cache-key == ''

      - name: Install yq
        if: inputs.sources-cache-key == ''
        run: |
          sudo wget -qO /usr/local/bin/yq "https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64"
          sudo chmod +x /usr/local/bin/yq

      - name: Generate sources cache key
        if: inputs.sources-cache-key == ''
        id: cache-key
        run: |
          KEY=$(./scripts/sources.sh cache-key)
          echo "key=sources-${KEY}" >> $GITHUB_OUTPUT
          echo "Sources cache key: sources-${KEY}"

      - name: Determine platform config
        id: config
        run: |
          case "${{ inputs.platform }}" in
            linux-x86_64)
              echo "runs-on=ubuntu-24.04" >> $GITHUB_OUTPUT
              echo "docker-platform=linux/amd64" >> $GITHUB_OUTPUT
              echo "docker-image=amd64/alpine:latest" >> $GITHUB_OUTPUT
              echo "use-qemu=false" >> $GITHUB_OUTPUT
              ;;
            linux-aarch64)
              echo "runs-on=ubuntu-24.04-arm" >> $GITHUB_OUTPUT
              echo "docker-platform=linux/arm64" >> $GITHUB_OUTPUT
              echo "docker-image=arm64v8/alpine:latest" >> $GITHUB_OUTPUT
              echo "use-qemu=false" >> $GITHUB_OUTPUT
              ;;
            linux-armv7)
              echo "runs-on=ubuntu-24.04-arm" >> $GITHUB_OUTPUT
              echo "docker-platform=linux/arm/v7" >> $GITHUB_OUTPUT
              echo "docker-image=arm32v7/alpine:latest" >> $GITHUB_OUTPUT
              echo "use-qemu=false" >> $GITHUB_OUTPUT
              ;;
            linux-riscv64)
              echo "runs-on=ubuntu-24.04" >> $GITHUB_OUTPUT
              echo "docker-platform=linux/riscv64" >> $GITHUB_OUTPUT
              echo "docker-image=riscv64/alpine:edge" >> $GITHUB_OUTPUT
              echo "use-qemu=true" >> $GITHUB_OUTPUT
              ;;
            linux-powerpc64le)
              echo "runs-on=ubuntu-24.04" >> $GITHUB_OUTPUT
              echo "docker-platform=linux/ppc64le" >> $GITHUB_OUTPUT
              echo "docker-image=ppc64le/alpine:latest" >> $GITHUB_OUTPUT
              echo "use-qemu=true" >> $GITHUB_OUTPUT
              ;;
            linux-s390x)
              echo "runs-on=ubuntu-24.04" >> $GITHUB_OUTPUT
              echo "docker-platform=linux/s390x" >> $GITHUB_OUTPUT
              echo "docker-image=s390x/alpine:latest" >> $GITHUB_OUTPUT
              echo "use-qemu=true" >> $GITHUB_OUTPUT
              ;;
            darwin-aarch64)
              echo "runs-on=macos-15" >> $GITHUB_OUTPUT
              ;;
            darwin-x86_64)
              echo "runs-on=macos-15-intel" >> $GITHUB_OUTPUT
              ;;
          esac

  build:
    name: Build ${{ inputs.target }}
    needs: setup
    runs-on: ${{ needs.setup.outputs.runs-on }}
    steps:
      - uses: actions/checkout@v4

      # For macOS: Install dependencies via brew
      - name: Init Dependencies (macOS)
        if: startsWith(inputs.platform, 'darwin')
        run: |
          xcrun simctl delete all || true
          sudo rm -rf ~/Library/Developer/CoreSimulator/Caches/* || true
          sudo defaults -currentHost write /Library/Preferences/com.apple.powerlogd SMCMonitorCadence 0 || true
          sudo launchctl unload -w /System/Library/LaunchDaemons/com.apple.PerfPowerServices.plist || true
          sudo killall PerfPowerServices || true
          sudo launchctl bootout system/com.apple.PerfPowerServices 2>/dev/null || true
          sudo launchctl bootout system/com.apple.metadata.mds 2>/dev/null || true

          wget https://github.com/biscuitehh/yeetd/releases/download/1.0/yeetd-normal.pkg
          sudo installer -pkg yeetd-normal.pkg -target /
          defaults write dev.biscuit.yeetd killapsd true
          yeetd &

          brew install \
            bash \
            make \
            gnu-sed \
            gawk \
            gpatch \
            coreutils \
            findutils \
            gcc@15 \
            perl \
            libtool \
            bison \
            texinfo \
            yq \
            rsync \
            vmtouch

          # Lock gcc/g++ in memory for faster access
          GCC_PREFIX=$(brew --prefix gcc@15)
          sudo vmtouch -l -h -f -d "$GCC_PREFIX"

      # Try cache first
      - name: Restore sources cache
        id: cache
        timeout-minutes: 10
        uses: actions/cache/restore@v5
        with:
          path: sources
          key: ${{ needs.setup.outputs.sources-cache-key }}

      # If cache miss, try artifact
      - name: Download sources from artifact
        if: steps.cache.outputs.cache-hit != 'true' && inputs.sources-artifact != ''
        timeout-minutes: 10
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.sources-artifact }}
          path: sources

      # If cache miss and no artifact, download directly
      - name: Download sources (Linux)
        if: steps.cache.outputs.cache-hit != 'true' && inputs.sources-artifact == '' && startsWith(inputs.platform, 'linux')
        run: |
          sudo wget -qO /usr/local/bin/yq "https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64"
          sudo chmod +x /usr/local/bin/yq
          bash ./scripts/sources.sh download -S sources

      - name: Download sources (macOS)
        if: steps.cache.outputs.cache-hit != 'true' && inputs.sources-artifact == '' && startsWith(inputs.platform, 'darwin')
        run: |
          bash ./scripts/sources.sh download -S sources

      # Save cache if we downloaded (not from artifact, to avoid redundant cache)
      - name: Save sources cache
        if: steps.cache.outputs.cache-hit != 'true'
        timeout-minutes: 10
        uses: actions/cache/save@v5
        with:
          path: sources
          key: ${{ needs.setup.outputs.sources-cache-key }}

      # For macOS: Create case-sensitive volumes for work and orig directories
      - name: Create Case-sensitive volumes (macOS)
        if: startsWith(inputs.platform, 'darwin')
        run: |
          diskutil list
          # disk3 for aarch64, disk1 for x86_64
          DISK=${{ contains(inputs.platform, 'aarch64') && 'disk3' || 'disk1' }}
          # RAM disk for work directory (x86_64 only, aarch64 has enough disk space)
          if [[ "${{ inputs.platform }}" == "darwin-x86_64" ]]; then
            diskutil erasevolume "Case-sensitive HFS+" cross $(hdiutil attach -nomount ram://10485760)
          else
            diskutil apfs addVolume $DISK "Case-sensitive APFS" cross
          fi
          # Physical disk for orig directory (case-sensitive for FreeBSD/NetBSD)
          diskutil apfs addVolume $DISK "Case-sensitive APFS" orig
          rsync -a --exclude=sources ./ /Volumes/cross/

      # For Linux with QEMU
      - name: Set up QEMU
        if: needs.setup.outputs.use-qemu == 'true'
        uses: docker/setup-qemu-action@v3

      # Build on Linux (Docker with tmpfs)
      - name: Build (Linux)
        if: startsWith(inputs.platform, 'linux')
        run: |
          docker run --rm \
            --platform ${{ needs.setup.outputs.docker-platform }} \
            --cap-add=IPC_LOCK \
            --tmpfs /work:exec,size=5G \
            --volume "${PWD}:/src:ro" \
            --volume "${PWD}/sources:/sources" \
            --volume "${PWD}/dist:/dist" \
            --volume "${PWD}/orig:/orig" \
            ${{ needs.setup.outputs.docker-image }} \
            /bin/sh -c '
              apk add --no-cache \
                coreutils \
                curl \
                bzip2 \
                xz \
                make \
                bison \
                rsync \
                patch \
                perl \
                flex \
                g++ \
                texinfo \
                python3 \
                gawk \
                grep \
                bash \
                tar \
                file \
                zip \
                yq && \
              apk add --no-cache vmtouch --repository=https://dl-cdn.alpinelinux.org/alpine/edge/testing && \
              vmtouch -l -h -f -d /usr/bin/g++ /usr/libexec/gcc /usr/lib/gcc && \
              rsync -a --exclude=sources /src/ /work/ && \
              find /sources -type f -exec touch {} + && \
              cd /work && \
              bash scripts/build.sh \
                -LDPl \
                -a \
                -S /sources \
                -R /orig \
                -o /dist \
                ${{ inputs.extra-build-flags }} \
                -T "${{ inputs.target }}"'

      - name: Build (macOS)
        if: startsWith(inputs.platform, 'darwin')
        working-directory: /Volumes/cross
        run: |
          find "${{ github.workspace }}/sources" -type f -exec touch {} +
          bash scripts/build.sh \
            -LDPl \
            -c "gcc-15" \
            -x "g++-15" \
            -a \
            -S "${{ github.workspace }}/sources" \
            -R /Volumes/orig \
            -o "${{ github.workspace }}/dist" \
            ${{ inputs.extra-build-flags }} \
            -T "${{ inputs.target }}"

      - name: Upload dist
        timeout-minutes: 10
        uses: actions/upload-artifact@v6
        with:
          name: ${{ inputs.target }}-${{ inputs.platform }}
          if-no-files-found: error
          path: dist

  # Release job uses reusable workflow
  release:
    name: Release ${{ inputs.target }}
    needs: build
    if: startsWith(github.ref, 'refs/tags/') || inputs.tag != ''
    uses: ./.github/workflows/release.yml
    with:
      target: ${{ inputs.target }}
      platform: ${{ inputs.platform }}
      tag: ${{ inputs.tag != '' && inputs.tag || github.ref_name }}
    secrets: inherit
