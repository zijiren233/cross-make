name: Single Target Build

on:
  workflow_dispatch:
    inputs:
      target:
        description: "Target to build"
        required: true
        type: string
      platform:
        description: "Platform"
        required: true
        type: choice
        options:
          - linux-x86_64
          - linux-aarch64
          - linux-armv7
          - linux-riscv64
          - linux-powerpc64le
          - linux-s390x
          - darwin-aarch64
          - darwin-x86_64
      tag:
        description: "Release tag (optional, defaults to current ref)"
        required: false
        type: string
        default: ""
      extra-build-flags:
        description: "Extra flags for build.sh"
        required: false
        type: string
        default: ""
  workflow_call:
    inputs:
      target:
        description: "Single target to build"
        required: true
        type: string
      platform:
        description: "Platform identifier (e.g., linux-aarch64, darwin-x86_64)"
        required: true
        type: string
      extra-build-flags:
        description: "Extra flags for build.sh"
        required: false
        type: string
        default: ""
      sources-cache-key:
        description: "Pre-computed sources cache key (skip calculation if provided)"
        required: false
        type: string
        default: ""
      sources-artifact:
        description: "Artifact name to download sources from (if provided, skip cache and download from artifact)"
        required: false
        type: string
        default: ""

jobs:
  setup:
    name: Setup
    runs-on: ubuntu-24.04
    outputs:
      runs-on: ${{ steps.config.outputs.runs-on }}
      docker-platform: ${{ steps.config.outputs.docker-platform }}
      docker-image: ${{ steps.config.outputs.docker-image }}
      use-qemu: ${{ steps.config.outputs.use-qemu }}
      sources-cache-key: ${{ inputs.sources-cache-key || steps.cache-key.outputs.key }}
    steps:
      - uses: actions/checkout@v4
        if: inputs.sources-cache-key == ''

      - name: Install yq
        if: inputs.sources-cache-key == ''
        run: |
          sudo wget -qO /usr/local/bin/yq "https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64"
          sudo chmod +x /usr/local/bin/yq

      - name: Generate sources cache key
        if: inputs.sources-cache-key == ''
        id: cache-key
        run: |
          KEY=$(./scripts/sources.sh cache-key)
          echo "key=sources-${KEY}" >> $GITHUB_OUTPUT
          echo "Sources cache key: sources-${KEY}"

      - name: Determine platform config
        id: config
        run: |
          case "${{ inputs.platform }}" in
            linux-x86_64)
              echo "runs-on=ubuntu-24.04" >> $GITHUB_OUTPUT
              echo "docker-platform=linux/amd64" >> $GITHUB_OUTPUT
              echo "docker-image=amd64/alpine:latest" >> $GITHUB_OUTPUT
              echo "use-qemu=false" >> $GITHUB_OUTPUT
              ;;
            linux-aarch64)
              echo "runs-on=ubuntu-24.04-arm" >> $GITHUB_OUTPUT
              echo "docker-platform=linux/arm64" >> $GITHUB_OUTPUT
              echo "docker-image=arm64v8/alpine:latest" >> $GITHUB_OUTPUT
              echo "use-qemu=false" >> $GITHUB_OUTPUT
              ;;
            linux-armv7)
              echo "runs-on=ubuntu-24.04-arm" >> $GITHUB_OUTPUT
              echo "docker-platform=linux/arm/v7" >> $GITHUB_OUTPUT
              echo "docker-image=arm32v7/alpine:latest" >> $GITHUB_OUTPUT
              echo "use-qemu=false" >> $GITHUB_OUTPUT
              ;;
            linux-riscv64)
              echo "runs-on=ubuntu-24.04" >> $GITHUB_OUTPUT
              echo "docker-platform=linux/riscv64" >> $GITHUB_OUTPUT
              echo "docker-image=riscv64/alpine:edge" >> $GITHUB_OUTPUT
              echo "use-qemu=true" >> $GITHUB_OUTPUT
              ;;
            linux-powerpc64le)
              echo "runs-on=ubuntu-24.04" >> $GITHUB_OUTPUT
              echo "docker-platform=linux/ppc64le" >> $GITHUB_OUTPUT
              echo "docker-image=ppc64le/alpine:latest" >> $GITHUB_OUTPUT
              echo "use-qemu=true" >> $GITHUB_OUTPUT
              ;;
            linux-s390x)
              echo "runs-on=ubuntu-24.04" >> $GITHUB_OUTPUT
              echo "docker-platform=linux/s390x" >> $GITHUB_OUTPUT
              echo "docker-image=s390x/alpine:latest" >> $GITHUB_OUTPUT
              echo "use-qemu=true" >> $GITHUB_OUTPUT
              ;;
            darwin-aarch64)
              echo "runs-on=macos-15" >> $GITHUB_OUTPUT
              ;;
            darwin-x86_64)
              echo "runs-on=macos-15-intel" >> $GITHUB_OUTPUT
              ;;
          esac

  build:
    name: Build ${{ inputs.target }}
    needs: setup
    runs-on: ${{ needs.setup.outputs.runs-on }}
    steps:
      - uses: actions/checkout@v4

      # For macOS: Install dependencies via brew
      - name: Init Dependencies (macOS)
        if: startsWith(inputs.platform, 'darwin')
        run: |
          xcrun simctl delete all || true
          sudo rm -rf ~/Library/Developer/CoreSimulator/Caches/* || true
          sudo defaults -currentHost write /Library/Preferences/com.apple.powerlogd SMCMonitorCadence 0 || true
          sudo launchctl unload -w /System/Library/LaunchDaemons/com.apple.PerfPowerServices.plist || true
          sudo killall PerfPowerServices || true
          sudo launchctl bootout system/com.apple.PerfPowerServices 2>/dev/null || true
          sudo launchctl bootout system/com.apple.metadata.mds 2>/dev/null || true

          wget https://github.com/biscuitehh/yeetd/releases/download/1.0/yeetd-normal.pkg
          sudo installer -pkg yeetd-normal.pkg -target /
          defaults write dev.biscuit.yeetd killapsd true
          yeetd &

          brew install \
            bash \
            make \
            gnu-sed \
            gawk \
            gpatch \
            coreutils \
            findutils \
            gcc@15 \
            perl \
            libtool \
            bison \
            texinfo \
            yq \
            rsync

      # Try cache first
      - name: Restore sources cache
        id: cache
        uses: actions/cache/restore@v5
        with:
          path: sources
          key: ${{ needs.setup.outputs.sources-cache-key }}

      # If cache miss, try artifact
      - name: Download sources from artifact
        if: steps.cache.outputs.cache-hit != 'true' && inputs.sources-artifact != ''
        uses: actions/download-artifact@v7
        with:
          name: ${{ inputs.sources-artifact }}
          path: sources

      # If cache miss and no artifact, download directly
      - name: Download sources (Linux)
        if: steps.cache.outputs.cache-hit != 'true' && inputs.sources-artifact == '' && startsWith(inputs.platform, 'linux')
        run: |
          sudo wget -qO /usr/local/bin/yq "https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64"
          sudo chmod +x /usr/local/bin/yq
          bash ./scripts/sources.sh download -S sources

      - name: Download sources (macOS)
        if: steps.cache.outputs.cache-hit != 'true' && inputs.sources-artifact == '' && startsWith(inputs.platform, 'darwin')
        run: |
          bash ./scripts/sources.sh download -S sources

      # Save cache if we downloaded (not from artifact, to avoid redundant cache)
      - name: Save sources cache
        if: steps.cache.outputs.cache-hit != 'true'
        uses: actions/cache/save@v5
        with:
          path: sources
          key: ${{ needs.setup.outputs.sources-cache-key }}

      # For macOS: Create case-sensitive volume
      - name: Create Case-sensitive volume
        if: startsWith(inputs.platform, 'darwin')
        run: |
          diskutil list
          if [[ "${{ inputs.platform }}" == "darwin-x86_64" ]]; then
            diskutil erasevolume "Case-sensitive HFS+" cross $(hdiutil attach -nomount ram://10485760)
          else
            # aarch64 使用物理磁盘
            diskutil apfs addVolume disk3 "Case-sensitive APFS" cross
          fi
          rsync -a --exclude=sources ./ /Volumes/cross/

      # For Linux with QEMU
      - name: Set up QEMU
        if: needs.setup.outputs.use-qemu == 'true'
        uses: docker/setup-qemu-action@v3

      # Build on Linux (Docker with tmpfs)
      - name: Build (Linux)
        if: startsWith(inputs.platform, 'linux')
        run: |
          docker run --rm \
            --platform ${{ needs.setup.outputs.docker-platform }} \
            --tmpfs /work:exec,size=5G \
            --volume "${PWD}:/src:ro" \
            --volume "${PWD}/sources:/sources" \
            --volume "${PWD}/dist:/dist" \
            --volume "${PWD}/orig:/orig" \
            ${{ needs.setup.outputs.docker-image }} \
            /bin/sh -c '
              apk add --no-cache \
                coreutils \
                curl \
                bzip2 \
                xz \
                make \
                bison \
                rsync \
                patch \
                perl \
                flex \
                g++ \
                texinfo \
                python3 \
                gawk \
                grep \
                bash \
                tar \
                file \
                zip \
                yq \
                mold && \
              rsync -a --exclude=sources /src/ /work/ && \
              find /sources -type f -exec touch {} + && \
              cd /work && \
              bash scripts/build.sh \
                -LDPl \
                -a \
                -d mold \
                -S /sources \
                -R /orig \
                -o /dist \
                ${{ inputs.extra-build-flags }} \
                -T "${{ inputs.target }}"'

      # Build on macOS (mold/lld not supported, use default linker)
      - name: Build (macOS)
        if: startsWith(inputs.platform, 'darwin')
        working-directory: /Volumes/cross
        run: |
          find "${{ github.workspace }}/sources" -type f -exec touch {} +
          bash scripts/build.sh \
            -LDPl \
            -c "gcc-15" \
            -x "g++-15" \
            -a \
            -S "${{ github.workspace }}/sources" \
            -R "${{ github.workspace }}/orig" \
            -o "${{ github.workspace }}/dist" \
            ${{ inputs.extra-build-flags }} \
            -T "${{ inputs.target }}"

      - name: Upload dist
        uses: actions/upload-artifact@v6
        with:
          name: ${{ inputs.target }}-${{ inputs.platform }}
          if-no-files-found: error
          path: dist

  # Release job runs immediately after this target's build completes
  release:
    name: Release ${{ inputs.target }}
    needs: build
    if: startsWith(github.ref, 'refs/tags/') || inputs.tag != ''
    runs-on: ubuntu-24.04
    env:
      RELEASE_TAG_BASE: ${{ inputs.tag != '' && inputs.tag || github.ref_name }}
    steps:
      - uses: actions/checkout@v4

      - name: Download artifact
        uses: actions/download-artifact@v7
        with:
          name: ${{ inputs.target }}-${{ inputs.platform }}
          path: dist

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq "https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64"
          sudo chmod +x /usr/local/bin/yq

      - name: Generate release notes
        id: release_notes
        run: |
          NOTES=$(bash scripts/generate-release-notes.sh "${{ env.RELEASE_TAG_BASE }}")
          echo "NOTES<<EOF" >> $GITHUB_OUTPUT
          echo "$NOTES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create or update release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RELEASE_NOTES: ${{ steps.release_notes.outputs.NOTES }}
        run: |
          RELEASE_TAG="${{ env.RELEASE_TAG_BASE }}-${{ inputs.platform }}"

          # Create release if it doesn't exist
          # Use --target to point to current commit, preventing auto-creation of new git tag
          gh release view "${{ env.RELEASE_TAG_BASE }}" --repo ${{ github.repository }} || \
            gh release create "${{ env.RELEASE_TAG_BASE }}" --repo ${{ github.repository }} --title "${{ env.RELEASE_TAG_BASE }}" --notes "$RELEASE_NOTES" --target ${{ github.sha }} || true
          gh release view "$RELEASE_TAG" --repo ${{ github.repository }} || \
            gh release create "$RELEASE_TAG" --repo ${{ github.repository }} --title "$RELEASE_TAG" --notes "$RELEASE_NOTES" --target ${{ github.sha }} --latest=false || true

      - name: Upload to release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          RELEASE_TAG="${{ env.RELEASE_TAG_BASE }}-${{ inputs.platform }}"

          # Upload all files in dist directory
          for file in dist/*; do
            if [ -f "$file" ]; then
              echo "Uploading: $file"
              if [[ "$file" == *"native"* ]]; then
                gh release upload "${{ env.RELEASE_TAG_BASE }}" "$file" --clobber --repo ${{ github.repository }}
              else
                gh release upload "$RELEASE_TAG" "$file" --clobber --repo ${{ github.repository }}
              fi
            fi
          done
